# üöÄ Flask K8s DevSecOps - Complete CI/CD Security Pipeline

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Docker](https://img.shields.io/badge/Docker-20.10%2B-blue)](https://www.docker.com/)
[![Kubernetes](https://img.shields.io/badge/Kubernetes-1.30%2B-326ce5)](https://kubernetes.io/)
[![Python](https://img.shields.io/badge/Python-3.9%2B-green)](https://www.python.org/)

Une solution compl√®te de d√©ploiement s√©curis√© d'applications Flask sur Kubernetes avec pipeline DevSecOps int√©gr√©, monitoring avanc√© et centralisation des logs.

## üìã Table des Mati√®res

- [üéØ Vue d'ensemble](#-vue-densemble)
- [üèóÔ∏è Architecture](#Ô∏è-architecture)
- [‚ö° Installation Rapide](#-installation-rapide)
- [üß© Composants](#-composants)
- [üîí S√©curit√©](#-s√©curit√©)
- [üìä Monitoring](#-monitoring)
- [üõ†Ô∏è D√©veloppement](#Ô∏è-d√©veloppement)
- [‚òÅÔ∏è D√©ploiement Cloud](#Ô∏è-d√©ploiement-cloud)
- [üîß Troubleshooting](#-troubleshooting)

## üéØ Vue d'ensemble

### ‚ú® Fonctionnalit√©s principales

| Composant | Description | Technologie |
|-----------|-------------|-------------|
| **üêç Application Flask** | API REST avec m√©triques et logs structur√©s | Python 3.9+, Prometheus |
| **üîÑ Pipeline DevSecOps** | CI/CD automatis√© avec scans s√©curis√©s | Jenkins, SonarQube, Trivy |
| **üì¶ Orchestration K8s** | D√©ploiement, scaling et gestion automatique | MicroK8s, Helm Charts |
| **üìä Monitoring Complet** | Logs centralis√©s et dashboards temps r√©el | Loki, Grafana, Alloy |
| **üîê S√©curit√© Int√©gr√©e** | Scans vuln√©rabilit√©s et qualit√© code | Trivy, SonarQube |
| **‚òÅÔ∏è Cloud Ready** | Support Azure avec acc√®s externe | LoadBalancer, Ingress |

### üé™ Nouveaut√©s de cette version

- ‚úÖ **Setup interactif** avec menu complet
- ‚úÖ **Installation Docker** automatis√©e
- ‚úÖ **Support Azure** int√©gr√© avec acc√®s externe
- ‚úÖ **Mode d√©veloppement** Docker Compose standalone
- ‚úÖ **Cleanup intelligent** par composants
- ‚úÖ **Logs color√©s** et tra√ßabilit√© compl√®te
- ‚úÖ **Multi-environnements** (dev, staging, prod)

## üèóÔ∏è Architecture

```mermaid
graph TB
    subgraph "DevSecOps Pipeline"
        A[Git Repo] --> B[Jenkins CI/CD]
        B --> C[SonarQube Analysis]
        B --> D[Trivy Security Scan]
        B --> E[Docker Build & Push]
        E --> F[K8s Deployment]
    end
    
    subgraph "Kubernetes Cluster"
        F --> G[Flask Application]
        G --> H[Service Mesh]
        H --> I[Ingress Controller]
    end
    
    subgraph "Monitoring Stack"
        G --> J[Alloy Collector]
        J --> K[Loki Storage]
        K --> L[Grafana Dashboards]
    end
    
    subgraph "External Access"
        I --> M[Local DNS]
        I --> N[Azure LoadBalancer]
    end
```

### ÔøΩ Stack Technologique

| Couche | Technologie | Version | R√¥le |
|--------|-------------|---------|------|
| **App** | Flask + Gunicorn | 2.3.3 | API REST, m√©triques |
| **Container** | Docker + BuildKit | 24.0+ | Containerisation |
| **Orchestration** | MicroK8s | 1.30+ | Cluster Kubernetes |
| **Package Manager** | Helm | 3.8+ | D√©ploiement applications |
| **CI/CD** | Jenkins | 2.452+ | Pipeline automatis√© |
| **Security** | SonarQube + Trivy | Latest | Analyse code + vuln√©rabilit√©s |
| **Monitoring** | Loki + Grafana + Alloy | 3.0+ | Logs + visualisation |
| **Cloud** | Azure LoadBalancer | - | Acc√®s externe |

## ‚ö° Installation Rapide

### üöÄ Setup Automatis√© (Recommand√©)

```bash
# 1. Cloner le projet
git clone <repository-url>
cd Sample-DevSecOps

# 2. Rendre le script ex√©cutable
chmod +x setup.sh

# 3. Lancer le menu interactif
./setup.sh
```

Le menu vous propose les options suivantes :

```
üöÄ DevSecOps Setup Menu
======================
  1) Install Docker                    # Installation Docker automatis√©e
  2) Check Prerequisites              # V√©rification pr√©requis
  3) Setup MicroK8s                   # Configuration cluster K8s
  4) Build Jenkins Image              # Image Jenkins personnalis√©e
  5) Deploy Core Services             # Jenkins + SonarQube
  6) Deploy Monitoring Stack          # Loki + Grafana + Alloy
  7) Deploy Flask Application         # Application principale
  8) Configure Azure External Access  # Acc√®s cloud
  9) Full Production Setup            # Installation compl√®te (3-7)
 10) Development Mode                 # Docker Compose local
 11) Cleanup Options                  # Nettoyage par composants
 12) Show Access Information          # URLs et credentials
 13) Exit
```

### ‚ö° Installation Express (Production)

```bash
./setup.sh
# Choisir option 9 pour l'installation compl√®te
```

### üß™ Mode D√©veloppement Local

```bash
./setup.sh
# Choisir option 10 pour Docker Compose
```

### üìã Pr√©requis Syst√®me

| Composant | Version Minimum | Recommand√© |
|-----------|----------------|------------|
| **OS** | Ubuntu 20.04+ | Ubuntu 22.04 LTS |
| **CPU** | 2 cores | 4+ cores |
| **RAM** | 4GB | 8GB+ |
| **Stockage** | 10GB libre | 20GB+ |
| **Docker** | 20.10+ | 24.0+ |
| **Git** | 2.25+ | Latest |

## üß© Composants

### üêç Application Flask

**Endpoints disponibles :**

```bash
GET  /                    # Page d'accueil avec statut
GET  /health              # Health check pour K8s
GET  /api/users           # Liste des utilisateurs (JSON)
POST /api/users           # Cr√©er utilisateur
PUT  /api/users/{id}      # Modifier utilisateur
DELETE /api/users/{id}    # Supprimer utilisateur
GET  /metrics             # M√©triques Prometheus
GET  /logs                # Interface logs temps r√©el
```

**Fonctionnalit√©s :**

- ‚úÖ Logs structur√©s JSON
- ‚úÖ M√©triques Prometheus int√©gr√©es
- ‚úÖ Health checks Kubernetes
- ‚úÖ Gestion d'erreurs centralis√©e
- ‚úÖ Rate limiting
- ‚úÖ CORS configur√©

### üîÑ Pipeline DevSecOps

**√âtapes du pipeline Jenkins :**

1. **üì• Checkout SCM** - R√©cup√©ration code source
2. **üì¶ Install Dependencies** - Installation packages Python
3. **üß™ Run Tests** - Tests unitaires avec coverage
4. **üìä SonarQube Analysis** - Analyse qualit√© code
5. **üîç Trivy FS Scan** - Scan filesystem vuln√©rabilit√©s
6. **üê≥ Build & Push Image** - Construction image Docker
7. **üõ°Ô∏è Trivy Image Scan** - Scan image vuln√©rabilit√©s
8. **üöÄ Deploy to K8s** - D√©ploiement Kubernetes

**Configuration automatique :**

- Int√©gration SonarQube avec tokens
- Registry Docker local MicroK8s
- D√©ploiement Rolling Update
- Tests automatis√©s avec rapports

### üìä Stack Monitoring

**Composants :**

| Service | Port | R√¥le | Configuration |
|---------|------|------|---------------|
| **Loki** | 3100 | Stockage logs | SingleBinary mode |
| **Grafana** | 3000 | Visualisation | Dashboards pr√©-configur√©s |
| **Alloy** | - | Collecteur logs | Auto-discovery K8s |

**Dashboards inclus :**

- üìà **Application Metrics** - Performance temps r√©el
- üîí **Security Dashboard** - √âv√©nements s√©curit√©
- üìã **Infrastructure** - √âtat cluster K8s
- üö® **Alerts** - Notifications automatiques

## üîí S√©curit√©

### üõ°Ô∏è Scans Automatis√©s

**SonarQube Analysis :**

```bash
# Configuration dans security/sonarqube/sonar-project.properties
sonar.projectKey=flask-k8s-devsecops
sonar.sources=app/
sonar.language=py
sonar.python.coverage.reportPaths=coverage.xml
```

**Trivy Security Scans :**

```bash
# Scan filesystem
trivy fs ./app --format table --severity HIGH,CRITICAL

# Scan Docker image
trivy image localhost:32000/flask-k8s-app:latest
```

### üîê S√©curit√© Impl√©ment√©e

| Aspect | Impl√©mentation | Outil |
|--------|----------------|-------|
| **Container Security** | Images non-root, minimal base | Docker |
| **Code Quality** | Analyse statique continue | SonarQube |
| **Vulnerability Scan** | Scan images + filesystem | Trivy |
| **Secrets Management** | Kubernetes secrets chiffr√©s | K8s |
| **Network Policies** | Isolation r√©seau pods | K8s NetworkPolicy |
| **RBAC** | Contr√¥le acc√®s granulaire | K8s RBAC |
| **TLS/SSL** | Chiffrement en transit | Ingress TLS |

### üìä Dashboard S√©curit√©

M√©triques surveill√©es :

- üö´ Tentatives authentification √©chou√©es
- ‚ö†Ô∏è Erreurs HTTP suspectes (4xx/5xx)
- üîç Patterns d'attaque d√©tect√©s
- üìà Anomalies trafic r√©seau

## üìä Monitoring

### üéØ M√©triques Application

**Prometheus Metrics :**

```python
# Compteurs requ√™tes
flask_requests_total{method="GET", endpoint="/api/users", status="200"}

# Latence requ√™tes
flask_request_duration_seconds{method="POST", endpoint="/api/users"}

# M√©triques business
flask_users_created_total
flask_errors_total{error_type="validation"}
```

### üìã Dashboards Grafana

**1. Application Dashboard :**

- üìä Taux de requ√™tes par endpoint
- ‚è±Ô∏è Latence P95/P99
- üìà Codes de statut HTTP
- üíæ Utilisation ressources

**2. Security Dashboard :**

- üîí √âchecs authentification
- üö® Alertes s√©curit√©
- üìä Top user agents suspects
- üåê G√©olocalisation connexions

**3. Infrastructure Dashboard :**

- üñ•Ô∏è M√©triques nodes K8s
- üì¶ √âtat des pods
- üíæ Utilisation stockage
- üåê Trafic r√©seau

### üö® Alertes Configur√©es

```yaml
# Exemple d'alerte Grafana
- alert: HighErrorRate
  expr: rate(flask_requests_total{status=~"5.."}[5m]) > 0.1
  for: 2m
  annotations:
    summary: "Taux d'erreur √©lev√© d√©tect√©"
```

## üõ†Ô∏è D√©veloppement

### üß™ Mode D√©veloppement Local

```bash
# D√©marrer avec Docker Compose
./setup.sh  # Option 10

# Ou manuellement
docker compose up -d

# V√©rifier les services
docker compose ps
```

**Services d√©veloppement :**

| Service | URL | Identifiants |
|---------|-----|--------------|
| Flask App | http://localhost:5000 | - |
| SonarQube | http://localhost:9000 | admin/admin |
| Grafana | http://localhost:3000 | admin/admin123 |
| Loki | http://localhost:3100 | - |

### üß™ Tests et Qualit√©

```bash
cd app/

# Tests unitaires
python -m pytest tests/ -v

# Tests avec couverture
python -m pytest tests/ --cov=. --cov-report=html

# Linting
flake8 app.py
black app.py --check

# Tests de charge
pip install locust
locust -f tests/load_test.py --host=http://localhost:5000
```

### üîß D√©veloppement avec Hot Reload

```bash
# Mode d√©veloppement Flask
cd app/
FLASK_ENV=development python app.py

# Avec volume Docker
docker run -v $(pwd)/app:/app -p 5000:5000 flask-k8s-app:latest
```

### üì¶ Build et Push Images

```bash
# Build local
docker build -t flask-k8s-app:latest ./app

# Tag pour registry
docker tag flask-k8s-app:latest localhost:32000/flask-k8s-app:latest

# Push vers MicroK8s registry
docker push localhost:32000/flask-k8s-app:latest
```

## ‚òÅÔ∏è D√©ploiement Cloud

### üå©Ô∏è Configuration Azure

```bash
# Configurer acc√®s externe Azure
./setup.sh  # Option 8

# V√©rifier IP externe
curl -s ifconfig.me
```

**Services LoadBalancer cr√©√©s :**

| Service | Port Externe | Port Interne |
|---------|--------------|--------------|
| Jenkins | 8080 | 8080 |
| SonarQube | 9000 | 9000 |
| Grafana | 3000 | 3000 |
| Flask App | 80 | 5000 |

### üîó URLs Acc√®s Externe

Apr√®s configuration Azure :

```bash
# Remplacer <EXTERNAL_IP> par votre IP publique
http://<EXTERNAL_IP>:8080  # Jenkins
http://<EXTERNAL_IP>:9000  # SonarQube  
http://<EXTERNAL_IP>:3000  # Grafana
http://<EXTERNAL_IP>       # Flask App
```

### üõ°Ô∏è S√©curit√© Cloud

**Configuration firewall Azure :**

```bash
# Ouvrir ports n√©cessaires
az network nsg rule create \
  --resource-group myResourceGroup \
  --nsg-name myNSG \
  --name DevSecOps-Ports \
  --protocol tcp \
  --priority 1000 \
  --destination-port-ranges 80 3000 8080 9000 \
  --access allow
```

### ÔøΩ Monitoring Cloud

- üìà **Azure Monitor** - M√©triques VM
- üîç **Application Insights** - APM
- üìã **Log Analytics** - Centralisation logs
- üö® **Azure Alerts** - Notifications

## ÔøΩüîß Troubleshooting

### ‚ùó Probl√®mes Courants

**1. Pods en √©tat Pending :**

```bash
# V√©rifier ressources
kubectl describe pod <pod-name> -n <namespace>
kubectl top nodes
microk8s inspect

# Solution : Augmenter ressources ou nettoyer
./setup.sh  # Option 11 pour cleanup
```

**2. Images Docker non trouv√©es :**

```bash
# V√©rifier registry local
docker images | grep localhost:32000

# Rebuilder si n√©cessaire
./setup.sh  # Option 4 puis 7
```

**3. Services inaccessibles :**

```bash
# V√©rifier ingress
kubectl get ingress -A
kubectl describe ingress -n flask-app

# V√©rifier /etc/hosts
grep "\.local" /etc/hosts
```

**4. Jenkins build failures :**

```bash
# V√©rifier logs Jenkins
kubectl logs -f deployment/jenkins -n jenkins

# V√©rifier Docker dans Jenkins
kubectl exec -it deployment/jenkins -n jenkins -- docker ps
```

### üîç Commandes Diagnostic

```bash
# √âtat g√©n√©ral cluster
kubectl get all -A
microk8s status

# Logs par service
kubectl logs -f deployment/flask-app -n flask-app
kubectl logs -f statefulset/loki -n monitoring

# Ressources utilis√©es
kubectl top pods -A
kubectl top nodes

# √âv√©nements r√©cents
kubectl get events --sort-by='.lastTimestamp' -A

# Storage et PVCs
kubectl get pv,pvc -A

# Network et services
kubectl get svc,endpoints -A
```

### üßπ Nettoyage et Reset

```bash
# Cleanup par composants
./setup.sh  # Option 11

# Reset complet
./setup.sh  # Option 11 -> Option 6

# Reset MicroK8s complet
microk8s reset
sudo snap remove microk8s
```

### üìû Support et Aide

| Probl√®me | Solution | Documentation |
|----------|----------|---------------|
| **Setup Issues** | Relancer `./setup.sh` option 2 | [Prerequisites](#-installation-rapide) |
| **Network Problems** | V√©rifier firewall et DNS | [Troubleshooting](#-troubleshooting) |
| **Performance** | Augmenter ressources VM | [Architecture](#Ô∏è-architecture) |
| **Security Scans** | V√©rifier config SonarQube/Trivy | [S√©curit√©](#-s√©curit√©) |

## üìö Documentation Compl√©mentaire

- üìñ [**Documentation Technique D√©taill√©e**](PROJECT_DOCUMENTATION.md)
- üöÄ [**Guide Architecture**](comparaison.md)
- ‚òÅÔ∏è [**Azure External Access**](AZURE_EXTERNAL_ACCESS.md)
- üõ†Ô∏è [**Helm Charts Documentation**](helm/)

## ü§ù Contribution

1. **Fork** le projet
2. **Cr√©er** une branche feature (`git checkout -b feature/amazing-feature`)
3. **Commit** les changements (`git commit -m 'Add amazing feature'`)
4. **Push** la branche (`git push origin feature/amazing-feature`)
5. **Ouvrir** une Pull Request

### üìã Guidelines

- ‚úÖ Tests unitaires pour nouvelles fonctionnalit√©s
- ‚úÖ Documentation mise √† jour
- ‚úÖ Respect des conventions de nommage
- ‚úÖ Scans s√©curit√© passants

## üìú Licence

Ce projet est sous licence MIT. Voir le fichier [LICENSE](LICENSE) pour plus de d√©tails.

---

<div align="center">

**üöÄ Cr√©√© avec ‚ù§Ô∏è pour l'apprentissage DevSecOps**

[![Stars](https://img.shields.io/github/stars/username/repo?style=social)](https://github.com/username/repo)
[![Forks](https://img.shields.io/github/forks/username/repo?style=social)](https://github.com/username/repo)
[![Issues](https://img.shields.io/github/issues/username/repo)](https://github.com/username/repo/issues)

[üêõ Reporter un Bug](https://github.com/username/repo/issues) ‚Ä¢ [üí° Demander une Fonctionnalit√©](https://github.com/username/repo/issues) ‚Ä¢ [üìñ Documentation](PROJECT_DOCUMENTATION.md)

</div>
