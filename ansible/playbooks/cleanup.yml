---
# Cleanup Operations Playbook

- name: "ğŸ§¹ Cleanup DevSecOps environment"
  hosts: devsecops
  become: yes
  gather_facts: yes

  tasks:
    - name: "ğŸ“ Display cleanup options"
      debug:
        msg:
          - "ğŸ§¹ Available cleanup operations:"
          - "  - Tag: jenkins (Remove Jenkins)"
          - "  - Tag: sonarqube (Remove SonarQube and PostgreSQL)"
          - "  - Tag: monitoring (Remove monitoring stack)"
          - "  - Tag: application (Remove Flask application)"
          - "  - Tag: external-access (Remove external access configs)"
          - "  - Tag: all (Complete cleanup)"

    - name: "ğŸ—‘ï¸ Cleanup Jenkins"
      block:
        - name: "âŒ Uninstall Jenkins Helm release"
          kubernetes.core.helm:
            name: "{{ jenkins.release_name }}"
            namespace: "{{ jenkins.namespace }}"
            state: absent
            kubeconfig: "{{ kubeconfig_path }}"
          become_user: "{{ ansible_user }}"
          environment:
            PATH: "/snap/bin:{{ ansible_env.PATH }}"
          failed_when: false

        - name: "ğŸ—‘ï¸ Delete Jenkins namespace"
          kubernetes.core.k8s:
            name: "{{ jenkins.namespace }}"
            api_version: v1
            kind: Namespace
            state: absent
            kubeconfig: "{{ kubeconfig_path }}"
          become_user: "{{ ansible_user }}"

        - name: "ğŸ—‘ï¸ Remove Jenkins Docker images"
          docker_image:
            name: "{{ item }}"
            state: absent
          loop:
            - "jenkins-devsecops:latest"
            - "{{ container_registry }}/jenkins-devsecops:latest"
          failed_when: false

        - name: "ğŸ“ Log Jenkins cleanup"
          lineinfile:
            path: "{{ remote_logs_path }}/deployment.log"
            line: "{{ ansible_date_time.iso8601 }} - Jenkins cleanup completed"
            create: yes

      tags: 
        - jenkins
        - all

    - name: "ğŸ—‘ï¸ Cleanup SonarQube and PostgreSQL"
      block:
        - name: "âŒ Uninstall SonarQube Helm release"
          kubernetes.core.helm:
            name: "{{ sonarqube.release_name }}"
            namespace: "{{ sonarqube.namespace }}"
            state: absent
            kubeconfig: "{{ kubeconfig_path }}"
          become_user: "{{ ansible_user }}"
          environment:
            PATH: "/snap/bin:{{ ansible_env.PATH }}"
          failed_when: false

        - name: "âŒ Uninstall PostgreSQL Helm release"
          kubernetes.core.helm:
            name: "{{ postgresql.release_name }}"
            namespace: "{{ sonarqube.namespace }}"
            state: absent
            kubeconfig: "{{ kubeconfig_path }}"
          become_user: "{{ ansible_user }}"
          environment:
            PATH: "/snap/bin:{{ ansible_env.PATH }}"
          failed_when: false

        - name: "ğŸ—‘ï¸ Delete SonarQube PVCs"
          command: microk8s kubectl delete pvc -n {{ sonarqube.namespace }} --all --ignore-not-found
          become_user: "{{ ansible_user }}"
          failed_when: false

        - name: "ğŸ—‘ï¸ Delete SonarQube namespace"
          kubernetes.core.k8s:
            name: "{{ sonarqube.namespace }}"
            api_version: v1
            kind: Namespace
            state: absent
            kubeconfig: "{{ kubeconfig_path }}"
          become_user: "{{ ansible_user }}"

        - name: "ğŸ“ Log SonarQube cleanup"
          lineinfile:
            path: "{{ remote_logs_path }}/deployment.log"
            line: "{{ ansible_date_time.iso8601 }} - SonarQube and PostgreSQL cleanup completed"
            create: yes

      tags: 
        - sonarqube
        - all

    - name: "ğŸ—‘ï¸ Cleanup monitoring stack"
      block:
        - name: "âŒ Uninstall Loki Helm release"
          kubernetes.core.helm:
            name: "{{ monitoring.loki.release_name }}"
            namespace: "{{ monitoring.namespace }}"
            state: absent
            kubeconfig: "{{ kubeconfig_path }}"
          become_user: "{{ ansible_user }}"
          environment:
            PATH: "/snap/bin:{{ ansible_env.PATH }}"
          failed_when: false

        - name: "âŒ Uninstall Grafana Helm release"
          kubernetes.core.helm:
            name: "{{ monitoring.grafana.release_name }}"
            namespace: "{{ monitoring.namespace }}"
            state: absent
            kubeconfig: "{{ kubeconfig_path }}"
          become_user: "{{ ansible_user }}"
          environment:
            PATH: "/snap/bin:{{ ansible_env.PATH }}"
          failed_when: false

        - name: "âŒ Uninstall Alloy Helm release"
          kubernetes.core.helm:
            name: "{{ monitoring.alloy.release_name }}"
            namespace: "{{ monitoring.namespace }}"
            state: absent
            kubeconfig: "{{ kubeconfig_path }}"
          become_user: "{{ ansible_user }}"
          environment:
            PATH: "/snap/bin:{{ ansible_env.PATH }}"
          failed_when: false

        - name: "ğŸ—‘ï¸ Delete monitoring namespace"
          kubernetes.core.k8s:
            name: "{{ monitoring.namespace }}"
            api_version: v1
            kind: Namespace
            state: absent
            kubeconfig: "{{ kubeconfig_path }}"
          become_user: "{{ ansible_user }}"

        - name: "ğŸ“ Log monitoring cleanup"
          lineinfile:
            path: "{{ remote_logs_path }}/deployment.log"
            line: "{{ ansible_date_time.iso8601 }} - Monitoring stack cleanup completed"
            create: yes

      tags: 
        - monitoring
        - all

    - name: "ğŸ—‘ï¸ Cleanup Flask application"
      block:
        - name: "ğŸ—‘ï¸ Delete Flask application resources"
          command: microk8s kubectl delete -f {{ remote_project_path }}/k8s/ --ignore-not-found
          become_user: "{{ ansible_user }}"
          failed_when: false

        - name: "ğŸ—‘ï¸ Delete Flask app namespace"
          kubernetes.core.k8s:
            name: "{{ flask_app.namespace }}"
            api_version: v1
            kind: Namespace
            state: absent
            kubeconfig: "{{ kubeconfig_path }}"
          become_user: "{{ ansible_user }}"

        - name: "ğŸ”„ Revert deployment image reference"
          replace:
            path: "{{ remote_project_path }}/k8s/deployment.yaml"
            regexp: 'image: {{ container_registry }}/{{ app_name }}:latest'
            replace: 'image: flask-k8s-app:latest'
          failed_when: false

        - name: "ğŸ—‘ï¸ Remove Flask Docker images"
          docker_image:
            name: "{{ item }}"
            state: absent
          loop:
            - "{{ app_name }}:latest"
            - "{{ container_registry }}/{{ app_name }}:latest"
          failed_when: false

        - name: "ğŸ“ Log application cleanup"
          lineinfile:
            path: "{{ remote_logs_path }}/deployment.log"
            line: "{{ ansible_date_time.iso8601 }} - Flask application cleanup completed"
            create: yes

      tags: 
        - application
        - all

    - name: "ğŸ—‘ï¸ Cleanup external access configurations"
      block:
        - name: "ğŸ—‘ï¸ Remove LoadBalancer services"
          kubernetes.core.k8s:
            name: "{{ item.name }}"
            namespace: "{{ item.namespace }}"
            api_version: v1
            kind: Service
            state: absent
            kubeconfig: "{{ kubeconfig_path }}"
          become_user: "{{ ansible_user }}"
          loop: "{{ external_access.load_balancers }}"
          failed_when: false

        - name: "ğŸ—‘ï¸ Remove external Ingress configurations"
          kubernetes.core.k8s:
            name: "{{ item.name }}"
            namespace: "{{ item.namespace }}"
            api_version: networking.k8s.io/v1
            kind: Ingress
            state: absent
            kubeconfig: "{{ kubeconfig_path }}"
          become_user: "{{ ansible_user }}"
          loop: "{{ external_access.external_ingresses }}"
          failed_when: false

        - name: "ğŸ“ Log external access cleanup"
          lineinfile:
            path: "{{ remote_logs_path }}/deployment.log"
            line: "{{ ansible_date_time.iso8601 }} - External access cleanup completed"
            create: yes

      tags: 
        - external-access
        - all

    - name: "ğŸ—‘ï¸ Cleanup Helm repositories"
      block:
        - name: "ğŸ—‘ï¸ Remove Helm repositories"
          command: microk8s helm3 repo remove {{ item.name }}
          become_user: "{{ ansible_user }}"
          loop: "{{ helm_repos }}"
          failed_when: false

        - name: "ğŸ“ Log Helm repositories cleanup"
          lineinfile:
            path: "{{ remote_logs_path }}/deployment.log"
            line: "{{ ansible_date_time.iso8601 }} - Helm repositories cleanup completed"
            create: yes

      tags: 
        - repositories
        - all

    - name: "ğŸ—‘ï¸ Development environment cleanup"
      block:
        - name: "ğŸ—‘ï¸ Stop Docker Compose services"
          docker_compose:
            project_src: "{{ project_root }}"
            state: absent
            remove_volumes: yes
          failed_when: false

        - name: "ğŸ“ Log development cleanup"
          lineinfile:
            path: "{{ remote_logs_path }}/deployment.log"
            line: "{{ ansible_date_time.iso8601 }} - Development environment cleanup completed"
            create: yes

      tags: 
        - development
        - docker-compose
        - all

    - name: "ğŸ—‘ï¸ Final cleanup"
      block:
        - name: "ğŸ—‘ï¸ Remove project directories"
          file:
            path: "{{ remote_project_path }}"
            state: absent
          when: "'all' in ansible_run_tags"

        - name: "ğŸ—‘ï¸ Clean up unused Docker images"
          command: docker image prune -f
          failed_when: false

        - name: "ğŸ—‘ï¸ Clean up unused Docker volumes"
          command: docker volume prune -f
          failed_when: false

        - name: "ğŸ“Š Display cleanup summary"
          debug:
            msg:
              - "âœ… Cleanup operations completed"
              - "ğŸ—‘ï¸ Removed components based on selected tags"
              - "ğŸ“ Check logs at {{ remote_logs_path }}/deployment.log"
              - "ğŸ” Verify cleanup with: microk8s kubectl get all -A"

        - name: "ğŸ“ Log final cleanup"
          lineinfile:
            path: "{{ remote_logs_path }}/deployment.log"
            line: "{{ ansible_date_time.iso8601 }} - Cleanup operations completed for tags: {{ ansible_run_tags | join(', ') }}"
            create: yes

      tags: 
        - all
        - always

    - name: "âš ï¸ Display post-cleanup information"
      debug:
        msg:
          - "ğŸ§¹ Cleanup completed for: {{ ansible_run_tags | join(', ') }}"
          - "ğŸ” To verify cleanup: microk8s kubectl get all -A"
          - "ğŸ“Š To check remaining resources: microk8s kubectl get pvc -A"
          - "ğŸ—‚ï¸ Log files preserved at: {{ remote_logs_path }}/"
          - "ğŸ”„ To redeploy: ansible-playbook -i inventory/hosts.yml playbooks/site.yml"
      tags: always
