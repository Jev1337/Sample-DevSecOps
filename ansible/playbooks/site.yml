---
# Main DevSecOps Deployment Playbook
# This playbook orchestrates the complete DevSecOps environment deployment

- name: "ğŸš€ DevSecOps Environment Setup"
  hosts: devsecops
  become: yes
  gather_facts: yes
  
  vars:
    ansible_python_interpreter: /usr/bin/python3
    
  pre_tasks:
    - name: "ğŸ“‹ Display deployment information"
      debug:
        msg:
          - "ğŸ¯ Target Host: {{ inventory_hostname }}"
          - "ğŸ§ OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "ğŸ—ï¸  Architecture: {{ ansible_architecture }}"
          - "ğŸ’¾ Memory: {{ ansible_memtotal_mb }}MB"
          - "ğŸ’½ Disk Space: {{ ansible_mounts[0].size_available // 1024 // 1024 // 1024 }}GB available"
          - "ğŸŒ External IP: {{ external_ip }}"
          - "ğŸš€ Environment: {{ environment_type }}"
    
    - name: "â° Set deployment start time"
      set_fact:
        deployment_start_time: "{{ ansible_date_time.iso8601 }}"
    
    - name: "ğŸ“ Create project directories"
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ remote_project_path }}"
        - "{{ remote_logs_path }}"
        - "/tmp/devsecops"

  tasks:
    # Prerequisites and system setup
    - name: "ğŸ“ Install prerequisites"
      include: prerequisites.yml
      tags: 
        - prerequisites
        - base

    # Docker installation
    - name: "ğŸ³ Install and configure Docker"
      include: docker.yml
      tags:
        - docker
        - base

    # MicroK8s setup
    - name: "ğŸ”§ Setup MicroK8s"
      include: microk8s.yml
      tags:
        - microk8s
        - kubernetes
        - base

    # Core services deployment
    - name: "ğŸš€ Deploy Jenkins"
      include: jenkins.yml
      tags:
        - jenkins
        - core
        - production
      when: deployment_mode == "kubernetes"

    - name: "ğŸ” Deploy SonarQube"
      include: sonarqube.yml
      tags:
        - sonarqube
        - core
        - production
      when: deployment_mode == "kubernetes"

    # Monitoring stack
    - name: "ğŸ“Š Deploy monitoring stack"
      include: monitoring.yml
      tags:
        - monitoring
        - observability
        - production
      when: 
        - deployment_mode == "kubernetes"
        - features.monitoring_enabled

    # Application deployment
    - name: "ğŸ Deploy Flask application"
      include: application.yml
      tags:
        - application
        - app
        - production
      when: deployment_mode == "kubernetes"

    # External access configuration
    - name: "ğŸŒ Configure external access"
      include: azure-access.yml
      tags:
        - external-access
        - azure
        - production
      when: 
        - deployment_mode == "kubernetes"
        - features.azure_external_access

    # Development mode (Docker Compose)
    - name: "ğŸ§ª Setup development mode"
      include_tasks: development.yml
      tags:
        - development
        - docker-compose
      when: 
        - deployment_mode == "docker-compose" or features.development_mode

  post_tasks:
    - name: "â° Calculate deployment time"
      set_fact:
        deployment_end_time: "{{ ansible_date_time.iso8601 }}"
        deployment_duration: "{{ (ansible_date_time.epoch | int) - (deployment_start_time | to_datetime('%Y-%m-%dT%H:%M:%SZ') | int) }}"

    - name: "âœ… Display deployment summary"
      debug:
        msg:
          - "ğŸ‰ DevSecOps deployment completed successfully!"
          - "â±ï¸  Total deployment time: {{ deployment_duration }} seconds"
          - "ğŸŒ Services are ready for access"
          - "ğŸ“‹ Check the access information below:"

    - name: "ğŸ”— Display access information"
      include_tasks: tasks/display_access_info.yml
      tags: always

  handlers:
    - name: restart docker
      service:
        name: docker
        state: restarted

    - name: restart microk8s
      command: microk8s stop && microk8s start

# Error handling playbook
- name: "ğŸ†˜ Handle deployment errors"
  hosts: devsecops
  gather_facts: no
  tasks:
    - name: "ğŸ“ Log deployment failure"
      lineinfile:
        path: "{{ remote_logs_path }}/deployment.log"
        line: "{{ ansible_date_time.iso8601 }} - DEPLOYMENT FAILED: {{ ansible_failed_result.msg | default('Unknown error') }}"
        create: yes
      when: ansible_failed_result is defined
      
    - name: "ğŸ” Display troubleshooting information"
      debug:
        msg:
          - "âŒ Deployment failed. Check the logs for details:"
          - "ğŸ“‚ Log location: {{ remote_logs_path }}/deployment.log"
          - "ğŸ”§ Troubleshooting guide: docs/troubleshooting.md"
          - "ğŸ“ Support: Check README.md for support information"
      when: ansible_failed_result is defined
