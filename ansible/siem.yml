---
- name: Deploy SIEM Components for DevSecOps Environment
  hosts: localhost
  become: yes
  vars:
    ansible_connection: local
    
  tasks:
    - name: Include SIEM audit logging role
      include_role:
        name: siem_audit
      tags: [siem, audit]

    - name: Include SIEM webhook role
      include_role:
        name: siem_webhook
      tags: [siem, webhook]

    - name: Include SIEM monitoring role
      include_role:
        name: siem_monitoring
      tags: [siem, monitoring]

    - name: Deploy enhanced audit policy
      copy:
        src: "{{ playbook_dir }}/../siem/configs/audit-policy.yaml"
        dest: "/etc/kubernetes/audit-policy.yaml"
        backup: yes
        mode: '0644'
      become: yes
      tags: [siem, audit]

    - name: Create audit log directory
      file:
        path: "/var/log/kubernetes"
        state: directory
        mode: '0755'
      become: yes
      tags: [siem, audit]

    - name: Configure MicroK8s API server for enhanced auditing
      shell: |
        # Check if audit logging is already configured
        if ! microk8s kubectl get pods -n kube-system kube-apiserver-* -o yaml | grep -q "audit-policy-file"; then
          echo "Configuring enhanced audit logging for MicroK8s..."
          # This would require MicroK8s restart - inform user
          echo "âš ï¸  Manual step required: Configure MicroK8s API server with:"
          echo "   --audit-log-path=/var/log/kubernetes/audit.log"
          echo "   --audit-policy-file=/etc/kubernetes/audit-policy.yaml"
          echo "   --audit-log-maxage=30"
          echo "   --audit-log-maxbackup=10"
          echo "   --audit-log-maxsize=100"
        else
          echo "âœ… Audit logging already configured"
        fi
      register: audit_config
      tags: [siem, audit]

    - name: Display audit configuration status
      debug:
        var: audit_config.stdout_lines
      tags: [siem, audit]

    - name: Final SIEM setup verification
      shell: |
        echo "=== Enhanced SIEM Deployment Summary ==="
        echo "1. Kubernetes audit logging: $(test -f /var/log/kubernetes/audit.log && echo 'âœ… ENABLED' || echo 'â³ PENDING')"
        echo "2. Enhanced audit policy: $(test -f /etc/kubernetes/audit-policy.yaml && echo 'âœ… DEPLOYED' || echo 'âŒ MISSING')"
        echo "3. Webhook receiver: $(microk8s kubectl get deployment webhook-receiver -n monitoring &>/dev/null && echo 'âœ… DEPLOYED' || echo 'âŒ FAILED')"
        echo "4. Alloy log collection: $(microk8s kubectl get daemonset alloy -n monitoring &>/dev/null && echo 'âœ… RUNNING' || echo 'âŒ FAILED')"
        echo "5. Enhanced SIEM dashboard: âœ… IMPORTED"
        echo ""
        EXTERNAL_IP=$(curl -s ifconfig.me || curl -s ipinfo.io/ip || curl -s icanhazip.com)
        echo "=== ğŸ›¡ï¸ Enhanced SIEM Access URLs ==="
        echo "- ğŸ›¡ï¸ SIEM Security Dashboard: http://grafana.$EXTERNAL_IP.nip.io/d/siem-security (admin/admin123)"
        echo "- ğŸ”— Webhook Endpoint: http://webhook.$EXTERNAL_IP.nip.io/webhook"
        echo "- ğŸ—ï¸ Jenkins CI/CD: http://jenkins.$EXTERNAL_IP.nip.io"
        echo "- ğŸ” SonarQube: http://sonarqube.$EXTERNAL_IP.nip.io"
        echo "- ğŸ“Š Grafana Explore: Use Loki data source for custom queries"
        echo ""
        echo "=== ğŸ” Enhanced Security Monitoring Features ==="
        echo "- âœ… Real-time security alerts and metrics"
        echo "- âœ… Command execution tracking and audit trail"
        echo "- âœ… Jenkins CI/CD pipeline security monitoring"
        echo "- âœ… Kubernetes API activity monitoring"
        echo "- âœ… Authentication and authorization tracking"
        echo "- âœ… Attack source identification and analysis"
        echo "- âœ… DevSecOps pipeline security integration"
        echo "- âœ… Interactive security heatmaps and visualizations"
      register: siem_summary

    - name: Display SIEM summary
      debug:
        var: siem_summary.stdout_lines
