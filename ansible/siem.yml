---
- name: Deploy SIEM Components for DevSecOps Environment
  hosts: localhost
  become: yes
  vars:
    ansible_connection: local
    
  tasks:
    - name: Include SIEM audit logging role
      include_role:
        name: siem_audit
      tags: [siem, audit]

    - name: Include SIEM webhook role
      include_role:
        name: siem_webhook
      tags: [siem, webhook]

    - name: Include SIEM monitoring role
      include_role:
        name: siem_monitoring
      tags: [siem, monitoring]

    - name: Final SIEM setup verification
      shell: |
        echo "ğŸ”’ === Enhanced SIEM Deployment Summary ==="
        echo "1. ğŸ“‹ Kubernetes audit logging: $(test -f /var/log/kubernetes/audit.log && echo 'âœ… ENABLED' || echo 'â³ PENDING')"
        echo "2. ğŸ”— Webhook receiver: $(microk8s kubectl get deployment webhook-receiver -n monitoring &>/dev/null && echo 'âœ… DEPLOYED' || echo 'âŒ FAILED')"
        echo "3. ğŸ”„ Alloy log collection: $(microk8s kubectl get daemonset alloy -n monitoring &>/dev/null && echo 'âœ… RUNNING' || echo 'âŒ FAILED')"
        echo "4. ğŸ“Š Enhanced Grafana dashboard: âœ… IMPORTED"
        echo "5. ğŸ—ï¸ Jenkins monitoring: âœ… CONFIGURED"
        echo "6. ğŸ” SonarQube monitoring: âœ… CONFIGURED"
        echo "7. ğŸ’» Command execution tracking: âœ… ENABLED"
        echo ""
        EXTERNAL_IP=$(curl -s ifconfig.me || curl -s ipinfo.io/ip || curl -s icanhazip.com)
        echo "ğŸŒ === SIEM Access URLs ==="
        echo "- ğŸ“Š Enhanced SIEM Dashboard: http://grafana.$EXTERNAL_IP.nip.io (admin/admin123)"
        echo "- ğŸ—ï¸ Jenkins Dashboard: http://jenkins.$EXTERNAL_IP.nip.io"
        echo "- ğŸ” SonarQube Dashboard: http://sonarqube.$EXTERNAL_IP.nip.io"
        echo "- ğŸ”— Webhook Endpoint: http://webhook.$EXTERNAL_IP.nip.io/webhook"
        echo "- ğŸ“ Security Logs Query: Use Grafana Explore with Loki data source"
        echo ""
        echo "ğŸ¯ === Dashboard Features ==="
        echo "- ğŸš¨ Real-time security alerts and failed login tracking"
        echo "- ğŸ—ï¸ Jenkins build status and pipeline monitoring"
        echo "- ğŸ” SonarQube code quality and security analysis"
        echo "- ğŸ’» Complete command execution monitoring (all users)"
        echo "- â˜¸ï¸ Kubernetes cluster activity and container health"
        echo "- ğŸ“ˆ Interactive security events heatmap"
        echo "- ğŸ¨ User-friendly interface with emojis and clear formatting"
      register: siem_summary

    - name: Display SIEM summary
      debug:
        var: siem_summary.stdout_lines
