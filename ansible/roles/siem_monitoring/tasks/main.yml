---
- name: Ensure Grafana Helm repository is added
  shell: |
    microk8s helm3 repo add grafana https://grafana.github.io/helm-charts || true
    microk8s helm3 repo update
  ignore_errors: yes

- name: Wait for Grafana service to be ready
  shell: |
    microk8s kubectl wait --for=condition=Ready pod -l app.kubernetes.io/name=grafana -n monitoring --timeout=300s
  ignore_errors: yes

- name: Get Grafana service port
  shell: |
    microk8s kubectl get svc grafana -n monitoring -o jsonpath='{.spec.ports[0].nodePort}'
  register: grafana_nodeport
  ignore_errors: yes

- name: Create Grafana dashboard directory
  file:
    path: /tmp/grafana-dashboards
    state: directory

- name: Copy Main SIEM dashboard
  copy:
    src: "{{ inventory_dir }}/../monitoring/grafana/dashboards/siem-real-security.json"
    dest: /tmp/grafana-dashboards/siem-real-security.json
  
- name: Copy Flask Security dashboard
  copy:
    src: "{{ inventory_dir }}/../monitoring/grafana/dashboards/security.json"
    dest: /tmp/grafana-dashboards/security.json

- name: Copy Flask General Logs dashboard
  copy:
    src: "{{ inventory_dir }}/../monitoring/grafana/dashboards/app-logs.json"
    dest: /tmp/grafana-dashboards/app-logs.json

- name: Configure SIEM dashboard via kubectl ConfigMap
  shell: |
    microk8s kubectl create configmap siem-dashboard-config \
      --from-file=/tmp/grafana-dashboards/siem-real-security.json \
      -n monitoring --dry-run=client -o yaml | \
    microk8s kubectl label --local -f - grafana_dashboard=1 -o yaml | \
    microk8s kubectl apply -f -
  ignore_errors: yes

- name: Update Alloy configuration for enhanced SIEM log collection
  shell: |
    # Create/update Alloy ConfigMap with enhanced SIEM configuration
    microk8s kubectl create configmap alloy-config \
      --from-file=config.alloy={{ inventory_dir }}/../monitoring/alloy/siem-config.alloy \
      -n monitoring --dry-run=client -o yaml | microk8s kubectl apply -f -
    
    # Update Alloy with enhanced values
    microk8s helm3 upgrade alloy grafana/alloy -n monitoring -f {{ inventory_dir }}/../helm/alloy/values.yaml
  register: alloy_upgrade
  ignore_errors: yes

- name: Restart Alloy to apply enhanced configuration
  shell: |
    microk8s kubectl rollout restart daemonset/alloy -n monitoring
    microk8s kubectl rollout status daemonset/alloy -n monitoring --timeout=120s
  register: alloy_restart

- name: Verify SIEM log collection
  shell: |
    # Test if logs are being collected
    microk8s kubectl logs -n monitoring -l app.kubernetes.io/name=alloy --tail=50
  register: alloy_logs
  ignore_errors: yes

- name: Display enhanced SIEM setup status
  debug:
    msg: |
      Enhanced SIEM monitoring configuration applied successfully!
      - Alloy has been updated with comprehensive log collection
      - Enhanced SIEM dashboard imported to Grafana with emojis and better UX
      - Log collection now includes:
        * SSH authentication events with source IP tracking
        * Command execution monitoring (all users, not just sudo)
        * Jenkins build status and pipeline tracking
        * SonarQube code analysis results
        * Kubernetes cluster events and API access
        * Webhook security events with detailed parsing
        * Dangerous command detection and alerting
        * Interactive heatmaps and performance metrics
      - Dashboard features:
        * Real-time security alerts with visual indicators
        * User-friendly interface with emojis and clear formatting
        * Command execution timeline with user attribution
        * Build status tracking with success/failure indicators
        * Enhanced filtering and search capabilities
