---
# Ensure required tools are installed: snap, git, curl
- name: Wait for automatic system updates to complete
  ansible.builtin.shell: |
    timeout=300  # 5 minutes timeout
    elapsed=0
    while pgrep -x "unattended-upgr" > /dev/null; do
      if [ $elapsed -ge $timeout ]; then
        echo "Timeout reached, forcefully stopping unattended-upgr"
        killall -9 unattended-upgr || true
        break
      fi
      echo "Waiting for unattended-upgr to complete... ($elapsed/$timeout seconds)"
      sleep 10
      elapsed=$((elapsed + 10))
    done
  become: true
  changed_when: false

- name: Kill any hanging apt processes
  ansible.builtin.shell: |
    # Stop unattended-upgrades service
    systemctl stop unattended-upgrades || true
    systemctl disable unattended-upgrades || true
    
    # Kill any hanging processes
    killall -9 apt-get || true
    killall -9 apt || true
    killall -9 dpkg || true
    killall -9 unattended-upgrade || true
    
    # Wait a moment for processes to die
    sleep 3
  become: true
  ignore_errors: true
  changed_when: false

- name: Remove apt locks and configure dpkg
  ansible.builtin.shell: |
    # Remove lock files
    rm -f /var/lib/dpkg/lock
    rm -f /var/lib/dpkg/lock-frontend
    rm -f /var/cache/apt/archives/lock
    rm -f /var/lib/apt/lists/lock
    
    # Configure dpkg
    dpkg --configure -a || true
  become: true
  ignore_errors: true
  changed_when: false

- name: Update apt cache
  ansible.builtin.shell: |
    apt-get clean
    apt-get update
  become: true
  retries: 5
  delay: 15
  register: apt_update_result
  until: apt_update_result.rc == 0
  ignore_errors: false

- name: Ensure snapd is installed
  ansible.builtin.package:
    name: snapd
    state: present
  become: true
  retries: 3
  delay: 10

- name: Ensure git is installed
  ansible.builtin.package:
    name: git
    state: present
  become: true
  retries: 3
  delay: 10

- name: Ensure curl is installed
  ansible.builtin.package:
    name: curl
    state: present
  become: true
  retries: 3
  delay: 10

- name: Ensure python3-pip is installed
  ansible.builtin.package:
    name: python3-pip
    state: present
  become: true
  retries: 3
  delay: 10

- name: Ensure python3-venv is installed
  ansible.builtin.package:
    name: python3-venv
    state: present
  become: true
  retries: 3
  delay: 10
