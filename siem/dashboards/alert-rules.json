{
  "apiVersion": 1,
  "groups": [
    {
      "name": "Security Alerts",
      "folder": "SIEM",
      "interval": "1m",
      "rules": [
        {
          "name": "Multiple Authentication Failures",
          "uid": "auth_failures",
          "condition": "B",
          "data": [
            {
              "refId": "A",
              "datasourceUid": "loki",
              "model": {
                "editorMode": "code",
                "expr": "sum(count_over_time({security_event_type=\"authentication_failure\"}[5m]))",
                "legendFormat": "",
                "queryType": "range",
                "refId": "A"
              },
              "relativeTimeRange": {
                "from": 300,
                "to": 0
              }
            },
            {
              "refId": "B",
              "datasourceUid": "__expr__",
              "model": {
                "conditions": [
                  {
                    "evaluator": {
                      "params": [5],
                      "type": "gt"
                    },
                    "operator": {
                      "type": "and"
                    },
                    "query": {
                      "params": ["A"]
                    },
                    "reducer": {
                      "params": [],
                      "type": "sum"
                    },
                    "type": "query"
                  }
                ],
                "datasource": {
                  "type": "__expr__",
                  "uid": "__expr__"
                },
                "expression": "",
                "hide": false,
                "refId": "B",
                "type": "classic_conditions"
              }
            }
          ],
          "noDataState": "OK",
          "execErrState": "OK",
          "for": "5m",
          "annotations": {
            "summary": "Multiple authentication failures detected",
            "description": "There have been more than 5 authentication failures in the last 5 minutes"
          },
          "labels": {
            "severity": "warning",
            "category": "security",
            "type": "authentication"
          }
        },
        {
          "name": "System File Change Detected",
          "uid": "file_change",
          "condition": "B",
          "data": [
            {
              "refId": "A",
              "datasourceUid": "loki",
              "model": {
                "editorMode": "code",
                "expr": "sum(count_over_time({security_event_type=\"system_file_change\"}[5m]))",
                "legendFormat": "",
                "queryType": "range",
                "refId": "A"
              },
              "relativeTimeRange": {
                "from": 300,
                "to": 0
              }
            },
            {
              "refId": "B",
              "datasourceUid": "__expr__",
              "model": {
                "conditions": [
                  {
                    "evaluator": {
                      "params": [0],
                      "type": "gt"
                    },
                    "operator": {
                      "type": "and"
                    },
                    "query": {
                      "params": ["A"]
                    },
                    "reducer": {
                      "params": [],
                      "type": "sum"
                    },
                    "type": "query"
                  }
                ],
                "datasource": {
                  "type": "__expr__",
                  "uid": "__expr__"
                },
                "expression": "",
                "hide": false,
                "refId": "B",
                "type": "classic_conditions"
              }
            }
          ],
          "noDataState": "OK",
          "execErrState": "OK",
          "for": "0m",
          "annotations": {
            "summary": "System file change detected",
            "description": "One or more critical system files have been modified"
          },
          "labels": {
            "severity": "critical",
            "category": "security",
            "type": "file_system"
          }
        },
        {
          "name": "Privilege Escalation Detected",
          "uid": "privilege_escalation",
          "condition": "B",
          "data": [
            {
              "refId": "A",
              "datasourceUid": "loki",
              "model": {
                "editorMode": "code",
                "expr": "sum(count_over_time({security_event_type=\"privilege_escalation\"}[5m]))",
                "legendFormat": "",
                "queryType": "range",
                "refId": "A"
              },
              "relativeTimeRange": {
                "from": 300,
                "to": 0
              }
            },
            {
              "refId": "B",
              "datasourceUid": "__expr__",
              "model": {
                "conditions": [
                  {
                    "evaluator": {
                      "params": [3],
                      "type": "gt"
                    },
                    "operator": {
                      "type": "and"
                    },
                    "query": {
                      "params": ["A"]
                    },
                    "reducer": {
                      "params": [],
                      "type": "sum"
                    },
                    "type": "query"
                  }
                ],
                "datasource": {
                  "type": "__expr__",
                  "uid": "__expr__"
                },
                "expression": "",
                "hide": false,
                "refId": "B",
                "type": "classic_conditions"
              }
            }
          ],
          "noDataState": "OK",
          "execErrState": "OK",
          "for": "1m",
          "annotations": {
            "summary": "Multiple privilege escalation events detected",
            "description": "There have been several privilege escalation events in a short time period"
          },
          "labels": {
            "severity": "high",
            "category": "security",
            "type": "privilege"
          }
        },
        {
          "name": "Package Management Activity",
          "uid": "package_activity",
          "condition": "B",
          "data": [
            {
              "refId": "A",
              "datasourceUid": "loki",
              "model": {
                "editorMode": "code",
                "expr": "sum(count_over_time({security_event_type=\"package_event\"}[10m]))",
                "legendFormat": "",
                "queryType": "range",
                "refId": "A"
              },
              "relativeTimeRange": {
                "from": 600,
                "to": 0
              }
            },
            {
              "refId": "B",
              "datasourceUid": "__expr__",
              "model": {
                "conditions": [
                  {
                    "evaluator": {
                      "params": [0],
                      "type": "gt"
                    },
                    "operator": {
                      "type": "and"
                    },
                    "query": {
                      "params": ["A"]
                    },
                    "reducer": {
                      "params": [],
                      "type": "sum"
                    },
                    "type": "query"
                  }
                ],
                "datasource": {
                  "type": "__expr__",
                  "uid": "__expr__"
                },
                "expression": "",
                "hide": false,
                "refId": "B",
                "type": "classic_conditions"
              }
            }
          ],
          "noDataState": "OK",
          "execErrState": "OK",
          "for": "0m",
          "annotations": {
            "summary": "Package management activity detected",
            "description": "Packages were installed, upgraded, or removed on the system"
          },
          "labels": {
            "severity": "info",
            "category": "security",
            "type": "package"
          }
        },
        {
          "name": "Multiple Failed SSH Attempts",
          "uid": "ssh_failures",
          "condition": "B",
          "data": [
            {
              "refId": "A",
              "datasourceUid": "loki",
              "model": {
                "editorMode": "code",
                "expr": "sum(count_over_time({security_event_type=\"authentication_failure\", message=~\".*ssh.*|.*sshd.*\"}[5m]))",
                "legendFormat": "",
                "queryType": "range",
                "refId": "A"
              },
              "relativeTimeRange": {
                "from": 300,
                "to": 0
              }
            },
            {
              "refId": "B",
              "datasourceUid": "__expr__",
              "model": {
                "conditions": [
                  {
                    "evaluator": {
                      "params": [10],
                      "type": "gt"
                    },
                    "operator": {
                      "type": "and"
                    },
                    "query": {
                      "params": ["A"]
                    },
                    "reducer": {
                      "params": [],
                      "type": "sum"
                    },
                    "type": "query"
                  }
                ],
                "datasource": {
                  "type": "__expr__",
                  "uid": "__expr__"
                },
                "expression": "",
                "hide": false,
                "refId": "B",
                "type": "classic_conditions"
              }
            }
          ],
          "noDataState": "OK",
          "execErrState": "OK",
          "for": "2m",
          "annotations": {
            "summary": "Multiple failed SSH login attempts detected",
            "description": "There have been more than 10 failed SSH login attempts in the last 5 minutes"
          },
          "labels": {
            "severity": "high",
            "category": "security",
            "type": "brute_force"
          }
        },
        {
          "name": "Application Error Rate High",
          "uid": "app_error_rate",
          "condition": "B",
          "data": [
            {
              "refId": "A",
              "datasourceUid": "loki",
              "model": {
                "editorMode": "code",
                "expr": "sum by(namespace) (rate({namespace=~\"flask-app|jenkins|sonarqube\"} | json | __error__=\"\" | status_code=~\"5..\" [5m]))",
                "legendFormat": "{{namespace}}",
                "queryType": "range",
                "refId": "A"
              },
              "relativeTimeRange": {
                "from": 300,
                "to": 0
              }
            },
            {
              "refId": "B",
              "datasourceUid": "__expr__",
              "model": {
                "conditions": [
                  {
                    "evaluator": {
                      "params": [0.1],
                      "type": "gt"
                    },
                    "operator": {
                      "type": "and"
                    },
                    "query": {
                      "params": ["A"]
                    },
                    "reducer": {
                      "params": [],
                      "type": "max"
                    },
                    "type": "query"
                  }
                ],
                "datasource": {
                  "type": "__expr__",
                  "uid": "__expr__"
                },
                "expression": "",
                "hide": false,
                "refId": "B",
                "type": "classic_conditions"
              }
            }
          ],
          "noDataState": "OK",
          "execErrState": "OK",
          "for": "5m",
          "annotations": {
            "summary": "High application error rate detected",
            "description": "One or more applications have a high rate of 5xx errors"
          },
          "labels": {
            "severity": "warning",
            "category": "security",
            "type": "application"
          }
        }
      ]
    }
  ]
}
