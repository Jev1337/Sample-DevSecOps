server {
    listen 8080;
    access_log /var/log/nginx/webhook_access.log;
    error_log /var/log/nginx/webhook_error.log;
    
    location /webhook {
        add_header Content-Type application/json;
        
        # Log the request body
        set $request_body_file /var/log/nginx/webhook_request_$request_id;
        client_body_in_file_only on;
        client_body_temp_path /var/log/nginx/;
        
        # Simple security validation
        if ($http_x_github_event = "") {
            return 403 '{"status":"error", "message":"Missing GitHub Event header"}';
        }
        
        # Log webhook details
        if ($http_x_github_event) {
            access_log /var/log/nginx/webhook.log '{"timestamp":"$time_iso8601", "client":"$remote_addr", "method":"$request_method", "uri":"$request_uri", "github_event":"$http_x_github_event", "delivery_id":"$http_x_github_delivery", "user_agent":"$http_user_agent", "request_id":"$request_id"}';
        }
        
        # Return success response
        return 200 '{"status":"success", "message":"Webhook received", "event":"$http_x_github_event", "request_id":"$request_id"}';
    }
    
    # Health check endpoint
    location /health {
        return 200 '{"status":"healthy"}';
    }
}
